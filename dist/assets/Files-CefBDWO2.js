import{j as a,u as K,R as l,a as w}from"./index-D8mHM_0A.js";import{P as V}from"./Protected-BdHEd5Ge.js";import{y as G}from"./db-1gINX9ct.js";function C(s=""){if(typeof s!="string"||!s)return null;const n=s.trim();try{const c=new URL(n);if(c.hostname.includes("youtube.com")||c.hostname==="youtu.be"){let u="";if(c.hostname==="youtu.be"?u=c.pathname.slice(1).split("/")[0]:c.pathname.startsWith("/watch")?u=c.searchParams.get("v")||"":(c.pathname.startsWith("/shorts/")||c.pathname.startsWith("/embed/"))&&(u=c.pathname.split("/")[2]||""),u)return{provider:"youtube",src:`https://www.youtube.com/embed/${u}?rel=0&modestbranding=1`}}}catch{}const h=n.match(/^https?:\/\/(?:www\.)?vimeo\.com\/(\d+)/i);if(h)return{provider:"vimeo",src:`https://player.vimeo.com/video/${h[1]}`};const d=n.match(/^https?:\/\/(?:www\.)?dailymotion\.com\/video\/([a-z0-9]+)/i);if(d)return{provider:"dailymotion",src:`https://www.dailymotion.com/embed/video/${d[1]}`};const x=n.match(/^https?:\/\/(?:www\.)?rutube\.ru\/video\/([a-f0-9\-]{10,})/i);return x?{provider:"rutube",src:`https://rutube.ru/play/embed/${x[1]}`}:/^https?:\/\/soundcloud\.com\//i.test(n)?{provider:"soundcloud",src:`https://w.soundcloud.com/player/?url=${encodeURIComponent(n)}&color=%2334d399`}:null}function H({url:s,title:n="Embedded media",className:h=""}){const d=C(s);return d?a.jsx("div",{className:`relative w-full rounded-lg overflow-hidden bg-black/30 ${h}`,style:{paddingTop:"56.25%"},children:a.jsx("iframe",{src:d.src,title:n,allow:"accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share",allowFullScreen:!0,loading:"lazy",referrerPolicy:"no-referrer-when-downgrade",className:"absolute inset-0 w-full h-full"})}):null}function z(s){return/\.(png|jpe?g|gif|webp|avif|bmp|svg)(\?.*)?$/i.test(s)}function I(s){return/\.(mp4|webm|mov|m4v|ogv)(\?.*)?$/i.test(s)}function _(s){return/\.(mp3|wav|ogg|aac|m4a|flac)(\?.*)?$/i.test(s)}function M(s=""){return!s||C(s)?"link":I(s)?"video":_(s)?"audio":z(s)?"image":"link"}function Q({item:s}){const n=s.url||"";return C(n)?a.jsx(H,{url:n,title:s.name||"Видео"}):z(n)?a.jsx("div",{className:"relative w-full rounded-lg overflow-hidden",style:{paddingTop:"56.25%"},children:a.jsx("img",{src:n,alt:s.name,className:"absolute inset-0 w-full h-full object-cover",loading:"lazy",decoding:"async"})}):I(n)?a.jsx("div",{className:"relative w-full rounded-lg overflow-hidden",style:{paddingTop:"56.25%"},children:a.jsx("video",{src:n,className:"absolute inset-0 w-full h-full object-cover",controls:!0,preload:"metadata"})}):_(n)?a.jsx("audio",{src:n,className:"w-full",controls:!0,preload:"none"}):n?a.jsx("a",{href:n,target:"_blank",rel:"noreferrer",className:"text-accent-200 underline break-all",children:n}):a.jsx("div",{className:"text-white/60",children:"Нет предпросмотра"})}function ie(){const{toast:s}=K(),[n,h]=l.useState(G()),[d,x]=l.useState([]),[c,u]=l.useState(!0),[S,T]=l.useState(""),[k,D]=l.useState(""),[$,A]=l.useState(""),[b,R]=l.useState(""),[X,J]=l.useState(()=>{try{return localStorage.getItem("files_view")==="list"?"list":"grid"}catch{return"grid"}}),[v,F]=l.useState("all"),[E,O]=l.useState("date_desc"),[Y,Z]=l.useState(null),[ee,te]=l.useState(""),[y,L]=l.useState(()=>new Set),[j,m]=l.useState(null),[N,f]=l.useState(-1),g=l.useCallback(async()=>{try{u(!0);const e=await w("/api/files");x(Array.isArray(e)?e:[]),T("")}finally{u(!1)}},[]);l.useEffect(()=>{g()},[g]);async function U(e){if(!e)return;let t=e.trim();if(/^https?:\/\//i.test(t)||(t="https://"+t),d.some(r=>(r.url||"").trim()===t)){s("Такая ссылка уже есть");return}const p=t.split("/").pop()||"Файл";await w("/api/files",{method:"POST",body:{name:p,date:n,url:t}})}const W=async e=>{if(e.preventDefault(),!k.trim())return;let t=k.trim();if(/^https?:\/\//i.test(t)||(t="https://"+t),d.some(r=>(r.url||"").trim()===t)){s("Такая ссылка уже есть");return}const p=$.trim()||t.split("/").pop()||"Файл";try{await w("/api/files",{method:"POST",body:{name:p,date:n,url:t}}),D(""),A(""),await g(),s("Ссылка добавлена")}catch(r){T((r==null?void 0:r.message)||"Ошибка добавления")}},o=l.useMemo(()=>{let e=d.slice();if(v!=="all"&&(e=e.filter(t=>M(t.url)===v)),b.trim()){const t=b.toLowerCase();e=e.filter(i=>(i.name||"").toLowerCase().includes(t)||(i.url||"").toLowerCase().includes(t))}switch(E){case"date_asc":e.sort((t,i)=>String(t.date).localeCompare(String(i.date)));break;case"name_az":e.sort((t,i)=>String(t.name||"").localeCompare(String(i.name||"")));break;case"name_za":e.sort((t,i)=>String(i.name||"").localeCompare(String(t.name||"")));break;default:e.sort((t,i)=>String(i.date).localeCompare(String(t.date)))}return e},[d,v,b,E]),P=()=>L(new Set),q=()=>L(new Set(o.map(e=>e.id))),B=async()=>{for(const e of y)await w(`/api/files/${e}`,{method:"DELETE"});await g(),P(),s("Удалено")};return l.useEffect(()=>{const e=t=>{var p;const i=(p=document.activeElement)==null?void 0:p.tagName;if(!(i==="INPUT"||i==="TEXTAREA")&&((t.key==="a"||t.key==="A")&&(t.preventDefault(),q()),t.key==="Escape"&&P(),t.key==="Delete"&&y.size>0&&confirm(`Удалить выбранные (${y.size})?`)&&B(),t.key==="/")){t.preventDefault();const r=document.getElementById("files-search");r==null||r.focus()}};return window.addEventListener("keydown",e),()=>window.removeEventListener("keydown",e)},[y,o]),a.jsx(V,{children:a.jsxs("section",{className:"relative z-10 max-w-6xl mx-auto px-6 py-10",onDragOver:e=>{e.preventDefault(),e.dataTransfer.dropEffect="copy"},onDrop:async e=>{e.preventDefault();const t=e.dataTransfer.getData("text/uri-list")||e.dataTransfer.getData("text/plain");let i=0;if(t){const p=t.split(/\r?\n/).map(r=>r.trim()).filter(Boolean);for(const r of p)await U(r),i++}i>0&&(await g(),s(`Добавлено: ${i}`))},children:[a.jsxs("div",{className:"flex items-end justify-between gap-3",children:[a.jsx("h2",{className:"text-2xl font-semibold gradient-text",children:"Файлы"}),a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx("div",{className:"glass px-2 py-1 rounded-xl flex gap-1",children:["all","video","image","audio","link"].map(e=>a.jsx("button",{className:`glass-button ${v===e?"glass-toggle-active bg-white/10":""}`,onClick:()=>F(e),"aria-pressed":v===e,children:e==="all"?"Все":e==="video"?"Видео":e==="image"?"Картинки":e==="audio"?"Аудио":"Ссылки"},e))}),a.jsxs("select",{value:E,onChange:e=>O(e.target.value),className:"input w-auto",children:[a.jsx("option",{value:"date_desc",children:"Новые сверху"}),a.jsx("option",{value:"date_asc",children:"Старые сверху"}),a.jsx("option",{value:"name_az",children:"Имя A→Я"}),a.jsx("option",{value:"name_za",children:"Имя Я→A"})]}),a.jsx("input",{id:"files-search",value:b,onChange:e=>R(e.target.value),placeholder:"Поиск /",className:"input w-48"})]})]}),S&&a.jsxs("div",{className:"mt-3 glass p-3 rounded-xl text-sm text-red-300",children:["Ошибка: ",S==="unauthorized"?"Нужна авторизация — войдите заново.":S]}),a.jsx("form",{onSubmit:W,className:"mt-4 glass p-4",children:a.jsxs("div",{className:"flex items-center gap-3 md:flex-row flex-col",children:[a.jsx("input",{value:k,onChange:e=>D(e.target.value),className:"input md:flex-1 w-full",placeholder:"Вставьте ссылку (https://...)","aria-label":"Ссылка"}),a.jsx("input",{value:$,onChange:e=>A(e.target.value),className:"input md:w-72 w-full",placeholder:"Название (опционально)","aria-label":"Название"}),a.jsx("input",{type:"date",value:n,onChange:e=>h(e.target.value),className:"input md:w-44 w-full","aria-label":"Дата"}),a.jsx("button",{type:"submit",className:"glass-button ml-auto",children:"Добавить"})]})}),a.jsx("div",{className:"mt-6",children:a.jsx(FileGrid,{items:o,loading:c,emptyText:d.length===0?"Пока нет файлов":"Ничего не найдено",onPreview:e=>{m(e),f(o.findIndex(t=>t.id===e.id))},onOpen:e=>{e.url&&window.open(e.url,"_blank","noopener")},onCopy:async e=>{if(e.url)try{await navigator.clipboard.writeText(e.url),s("Скопировано")}catch{}},onDelete:async e=>{await w(`/api/files/${e.id}`,{method:"DELETE"}),await g(),s("Удалено")},onRename:async e=>{const t=prompt("Новое имя",e.name||"");if(t==null)return;const i=t.trim();!i||i===(e.name||"")||(await w(`/api/files/${e.id}`,{method:"PATCH",body:{name:i}}),await g(),s("Название обновлено"))}})}),j&&a.jsx("div",{className:"fixed inset-0 z-50 bg-black/70 backdrop-blur-sm flex items-center justify-center p-4",onClick:()=>{m(null),f(-1)},onKeyDown:e=>{if(e.key==="Escape"&&(m(null),f(-1)),e.key==="ArrowLeft"){const t=(N-1+o.length)%o.length;m(o[t]),f(t)}if(e.key==="ArrowRight"){const t=(N+1)%o.length;m(o[t]),f(t)}},role:"dialog","aria-modal":"true",tabIndex:-1,children:a.jsxs("div",{className:"relative max-w-4xl w-full",onClick:e=>e.stopPropagation(),children:[a.jsx(Q,{item:j}),a.jsxs("div",{className:"mt-3 flex justify-between items-center",children:[a.jsx("div",{className:"text-neutral-200 truncate",children:j.name||j.url}),a.jsxs("div",{className:"btn-group",children:[a.jsx("button",{className:"glass-button",onClick:()=>{const e=(N-1+o.length)%o.length;m(o[e]),f(e)},"aria-label":"Предыдущий",children:"◀"}),a.jsx("button",{className:"glass-button",onClick:()=>{const e=(N+1)%o.length;m(o[e]),f(e)},"aria-label":"Следующий",children:"▶"}),a.jsx("button",{className:"glass-button",onClick:()=>{m(null),f(-1)},"aria-label":"Закрыть",children:"Закрыть"})]})]})]})})]})})}export{ie as default};
